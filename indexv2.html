<!DOCTYPE html> 
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGDP Dashboard | React</title>
    
    <!-- React + Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fuente -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #204B42; 
            --primary-hover: #163630;
            --bg-body: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text-main: #0f172a;
            --text-light: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6; 
            --header-height: 64px;
            --sidebar-width: 240px;
        }

        body.dark-mode {
            --primary: #2d6a5e;
            --bg-body: #0f172a;       
            --surface: #1e293b;       
            --border: #334155;        
            --text-main: #f1f5f9;     
            --text-light: #94a3b8;    
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; }

        #root:empty::before {
            content: 'Iniciando AGDP System...';
            display: flex; height: 100vh; justify-content: center; 
            align-items: center; color: var(--primary); font-weight: 600;
        }

        .app-container { display: flex; flex-direction: column; height: 100vh; }
        .main-layout { display: flex; flex: 1; overflow: hidden; position: relative; }

        header { background-color: #204B42; height: var(--header-height); padding: 0 1.5rem; display: flex; justify-content: space-between; align-items: center; color: white; flex-shrink: 0; z-index: 50; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .brand { display: flex; align-items: center; gap: 1rem; }
        .brand h1 { font-size: 1.1rem; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 0.5rem; }
        .logo-box { width:32px; height:32px; background:white; color:#204B42; font-weight:bold; display:flex; align-items:center; justify-content:center; border-radius:4px; font-size: 0.8rem; }
        .version-badge { font-size: 0.7rem; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px; font-weight: 400; opacity: 0.9; }
        
        .header-actions { display: flex; gap: 0.8rem; align-items: center; }
        .user-type-badge { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem; }
        .nav-icon-btn { background: rgba(255,255,255,0.15); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative; transition: background 0.2s; }
        .nav-icon-btn:hover { background: rgba(255,255,255,0.25); }
        .notif-dot { position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: var(--danger); border-radius: 50%; border: 1px solid #204B42; }
        
        .user-profile { display: flex; align-items: center; gap: 0.5rem; background: white; color: #204B42; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
        .user-profile:hover { transform: translateY(-1px); }

        .sidebar { width: var(--sidebar-width); background-color: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding-top: 1rem; transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 40; flex-shrink: 0; }
        .sidebar.collapsed { margin-left: calc(var(--sidebar-width) * -1); }
        .sidebar-item { display: flex; gap: 0.8rem; padding: 0.8rem 1.5rem; color: var(--text-light); cursor: pointer; font-size: 0.9rem; align-items: center; text-decoration: none; border-left: 3px solid transparent; transition: all 0.2s; font-weight: 500; }
        .sidebar-item:hover { background: var(--bg-body); color: var(--primary); }
        .sidebar-item.active { color: var(--primary); background: rgba(32, 75, 66, 0.08); border-left-color: var(--primary); }
        .sidebar-footer { margin-top: auto; padding: 1rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; }

        .dashboard-content { flex: 1; padding: 1.5rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1.5rem; background-color: var(--bg-body); }

        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
        .kpi-card { background: var(--surface); border: 1px solid var(--border); padding: 1.25rem; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 0.5rem; position: relative; }
        .kpi-card.clickable { cursor: pointer; transition: border-color 0.2s, transform 0.1s; }
        .kpi-card.clickable:hover { border-color: var(--primary); transform: translateY(-1px); }
        .kpi-header { display: flex; justify-content: space-between; align-items: center; color: var(--text-light); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-label { display: flex; gap: 0.5rem; align-items: center; }
        .kpi-value { font-size: 1.75rem; font-weight: 700; color: var(--text-main); line-height: 1.2; }
        .kpi-sub { font-size: 0.8rem; color: var(--text-light); }
        .unit-badge { font-size: 0.65rem; background: var(--bg-body); padding: 2px 8px; border-radius: 12px; display: flex; gap: 4px; align-items: center; border: 1px solid var(--border); font-weight: 700; color: var(--primary); }

        .filters-panel { background: var(--surface); padding: 1.25rem; border-radius: 8px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 1.25rem; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
        .filters-row { display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; }
        .actions-row { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border); padding-top: 1rem; flex-wrap: wrap; gap: 1rem; }
        
        .form-input, .form-select { padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-body); color: var(--text-main); font-size: 0.85rem; height: 38px; outline: none; transition: border-color 0.2s; font-family: inherit; }
        .form-input:focus, .form-select:focus { border-color: var(--primary); }
        .date-input-wrapper { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--text-light); font-weight: 500; }
        
        .btn-group { display: flex; border: 1px solid var(--border); border-radius: 6px; overflow: hidden; height: 38px; }
        .btn-group-item { background: var(--surface); border: none; padding: 0 1rem; cursor: pointer; font-size: 0.85rem; border-right: 1px solid var(--border); display: flex; gap: 0.5rem; align-items: center; color: var(--text-light); transition: background 0.2s; }
        .btn-group-item:last-child { border-right: none; }
        .btn-group-item:hover { background: var(--bg-body); color: var(--text-main); }
        .btn-group-item.active { background: var(--primary); color: white; }

        .btn { padding: 0 1rem; height: 38px; border-radius: 6px; border: 1px solid transparent; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-weight: 500; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-outline { border-color: var(--border); background: transparent; color: var(--text-main); }
        .btn-outline:hover { background-color: var(--bg-body); border-color: var(--text-light); }
        .btn-outline-danger { border-color: var(--border); background: transparent; color: var(--danger); }
        .btn-outline-danger:hover { background: #fef2f2; border-color: var(--danger); }
        .btn-icon { background: transparent; border: none; color: var(--text-light); cursor: pointer; padding: 4px; border-radius: 4px; display: flex; }
        .btn-icon:hover { background: var(--bg-body); color: var(--primary); }

        .stats-layout { display: grid; grid-template-columns: 3fr 1fr; gap: 1.5rem; min-height: 500px; }
        .table-wrapper { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; overflow: auto; box-shadow: 0 1px 2px rgba(0,0,0,0.03); display: flex; flex-direction: column; }
        
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem; }
        .data-table th { background: var(--bg-body); padding: 0.75rem 1rem; text-align: left; position: sticky; top: 0; font-weight: 600; color: var(--text-light); border-bottom: 1px solid var(--border); white-space: nowrap; z-index: 10; }
        .data-table td { padding: 0.6rem 1rem; border-bottom: 1px solid var(--border); color: var(--text-main); vertical-align: middle; white-space: nowrap; }
        .data-table tr:hover td { background-color: var(--bg-body); }
        
        .row-group td { background: var(--bg-body); font-weight: 600; color: var(--primary); }
        .badge-group { background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; border: 1px solid #bfdbfe; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .font-mono { font-family: 'Monaco', 'Consolas', monospace; letter-spacing: -0.5px; }

        .charts-sidebar { display: flex; flex-direction: column; gap: 1rem; }
        .chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1.25rem; flex: 1; display: flex; flex-direction: column; max-height: 350px; min-height: 200px; }
        .chart-card h4 { margin: 0 0 1rem 0; font-size: 0.8rem; color: var(--text-light); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
        .chart-container, .list-container { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0.6rem; padding-right: 4px; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .bar-row, .list-item { display: flex; align-items: center; gap: 0.75rem; font-size: 0.8rem; }
        .bar-label, .list-label { width: 100px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; text-align: right; color: var(--text-light); }
        .bar-track { flex: 1; background: var(--bg-body); height: 8px; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease-out; }
        .bar-val, .list-val { width: 70px; text-align: right; font-weight: 600; color: var(--text-main); }

        .dropdown { position: absolute; top: 50px; right: 0; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; width: 320px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); color: var(--text-main); z-index: 100; overflow: hidden; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .dd-header { padding: 0.8rem 1rem; border-bottom: 1px solid var(--border); font-weight: 600; background: var(--bg-body); font-size: 0.85rem; color: var(--text-light); }
        .dd-item { padding: 0.8rem 1rem; border-bottom: 1px solid var(--border); display: flex; gap: 0.8rem; font-size: 0.85rem; cursor: pointer; transition: background 0.2s; }
        .dd-item:hover { background: var(--bg-body); }
        .dd-item:last-child { border-bottom: none; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(4px); opacity: 0; animation: fadeIn 0.2s forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .modal-card { background: var(--surface); width: 100%; max-width: 500px; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); transform: scale(0.95); animation: scaleUp 0.2s forwards; }
        @keyframes scaleUp { to { transform: scale(1); } }
        .modal-card.modal-lg { max-width: 900px; height: 80vh; }
        .modal-header { padding: 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 1.1rem; }
        .form-grid { padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.4rem; }
        .form-label { font-size: 0.8rem; font-weight: 600; color: var(--text-light); }
        .section-title { font-size: 0.9rem; font-weight: 600; color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }

        .password-wrapper { position: relative; }
        .toggle-pass-btn { position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-light); }
        .modal-footer { padding: 1.25rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.75rem; background: var(--bg-body); border-radius: 0 0 12px 12px; }

        /* ESTABLECIMIENTOS: título y subtítulo */
        .est-header { display: flex; justify-content: space-between; align-items: center; gap: 1rem; width: 100%; }
        .est-title { font-size: 1rem; font-weight: 600; color: var(--text-main); }
        .est-subtitle { font-size: 0.8rem; color: var(--text-light); }

        /* Toggle Switch (Tablet) */
        .toggle-switch { position: relative; width: 36px; height: 20px; display: inline-block; vertical-align: middle; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(16px); }

        /* Tooltip */
        .tooltip-container { position: relative; display: inline-flex; align-items: center; margin-left: 6px; cursor: help; }
        .tooltip-container .tooltip-text { 
            visibility: hidden; width: 220px; background-color: #334155; color: #fff; text-align: center; 
            border-radius: 6px; padding: 8px; position: absolute; z-index: 100; bottom: 125%; 
            left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; font-weight: 400;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); pointer-events: none; line-height: 1.4;
        }
        .tooltip-container .tooltip-text::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #334155 transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

        /* Badge Ha + Owner */
        .ha-badge { font-size: 0.75rem; color: var(--text-light); background: #f1f5f9; padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border); display: inline-flex; align-items: center; gap: 4px; }
        .owner-badge { background: #e2e8f0; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; color: var(--text-light); font-weight: 500; }

        @media (max-width: 1024px) { 
            .stats-layout { grid-template-columns: 1fr; } 
            .chart-card { max-height: none; } 
        }
        @media (max-width: 768px) { 
            .sidebar { position: fixed; height: 100%; left: -100%; box-shadow: 5px 0 15px rgba(0,0,0,0.1); } 
            .sidebar.mobile-open { left: 0; } 
            .filters-row, .actions-row { flex-direction: column; align-items: stretch; }
            .user-type-badge, .brand span { display: none; }
            .kpi-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const IconWrapper = ({ children, size=24, color="currentColor", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>
        );

        const Icons = {
            Moon: (p) => <IconWrapper {...p}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></IconWrapper>,
            Sun: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></IconWrapper>,
            Bell: (p) => <IconWrapper {...p}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></IconWrapper>,
            CloudDownload: (p) => <IconWrapper {...p}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m8 17 4 4 4-4"/></IconWrapper>,
            User: (p) => <IconWrapper {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconWrapper>,
            Menu: (p) => <IconWrapper {...p}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></IconWrapper>,
            Settings: (p) => <IconWrapper {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconWrapper>,
            Download: (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconWrapper>,
            Layers: (p) => <IconWrapper {...p}><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></IconWrapper>,
            ChevronLeft: (p) => <IconWrapper {...p}><path d="m15 18-6-6 6-6"/></IconWrapper>,
            ChevronRight: (p) => <IconWrapper {...p}><path d="m9 18 6-6-6-6"/></IconWrapper>,
            X: (p) => <IconWrapper {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>,
            Eye: (p) => <IconWrapper {...p}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconWrapper>,
            EyeOff: (p) => <IconWrapper {...p}><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></IconWrapper>,
            AlertOctagon: (p) => <IconWrapper {...p}><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconWrapper>,
            AlertTriangle: (p) => <IconWrapper {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></IconWrapper>,
            Edit2: (p) => <IconWrapper {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconWrapper>,
            Trash2: (p) => <IconWrapper {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>,
            Grid: (p) => <IconWrapper {...p}><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></IconWrapper>,
            FileSpreadsheet: (p) => <IconWrapper {...p}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M8 13h2"/><path d="M14 13h2"/><path d="M8 17h2"/><path d="M14 17h2"/></IconWrapper>,
            FileText: (p) => <IconWrapper {...p}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></IconWrapper>,
            Maximize: (p) => <IconWrapper {...p}><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></IconWrapper>,
            Map: (p) => <IconWrapper {...p}><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="21"/><line x1="15" x2="15" y1="3" y2="21"/></IconWrapper>,
            ArrowUpDown: (p) => <IconWrapper {...p}><path d="m21 16-4 4-4-4"/><path d="M17 20V4"/><path d="m3 8 4-4 4 4"/><path d="M7 4v16"/></IconWrapper>,
            MapPin: (p) => <IconWrapper {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconWrapper>,
            Plus: (p) => <IconWrapper {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>,
            ChevronDown: (p) => <IconWrapper {...p}><path d="m6 9 6 6 6-6"/></IconWrapper>,
            Info: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconWrapper>,
            Layout: (p) => <IconWrapper {...p}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="9" x2="9" y1="21" y2="9"/></IconWrapper>,
        };

        const IconCosechadora = ({ size = 24, color = "currentColor" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="8" cy="17" r="3" />
                <circle cx="19" cy="17" r="2" />
                <path d="M4 17L4 12L7 12L9 8H16L18 12H21V17" />
                <path d="M1 14L4 14" />
                <path d="M1 11L4 12" />
                <path d="M1 17L4 16" />
                <path d="M4 11V17" /> 
                <path d="M12 8L10 4L16 3" />
            </svg>
        );

        const IconTolva = ({ size = 24, color = "currentColor" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="7.5" cy="17.5" r="2.5" />
                <circle cx="15.5" cy="17.5" r="2.5" />
                <circle cx="20.5" cy="18.5" r="1.5" />
                <path d="M3 10L5 17H10L12 10H3Z" />
                <path d="M3 10L2 8H13L12 10" />
                <path d="M8 10L8 5L2 5" />
                <path d="M13 17H18V12H13" />
                <path d="M13 12L14 9H17L18 12" />
                <path d="M18 14H22L23 18" />
                <path d="M10 16H13" />
            </svg>
        );

        const URL_MANIAGRO = "https://docs.google.com/spreadsheets/d/1IDhJ8E7h5d7ezknTK-BaJkF66ydHAy4zZAv4FLl9u0k/edit?usp=sharing";

        const SAMPLE_ROWS = [
            {
                "FECHA PESADA": "2025-03-01",
                "HORA PESADA": "10:15",
                "PRODUCTOR": "Productor Demo",
                "ESTABLECIMIENTO": "Estancia Norte",
                "LOTE": "Lote 1",
                "PRODUCTO": "Soja",
                "DESTINO DESCARGA": "Camión Puerto",
                "CARTA DE PORTE": "0001-00000001",
                "CONTRATISTA": "Contratista A",
                "TOLVA": "Tolva 01",
                "PESO HUMEDO Kg": "32500"
            },
            {
                "FECHA PESADA": "2025-03-02",
                "HORA PESADA": "16:40",
                "PRODUCTOR": "Productor Demo",
                "ESTABLECIMIENTO": "Estancia Sur",
                "LOTE": "Lote 7",
                "PRODUCTO": "Maíz",
                "DESTINO DESCARGA": "Silo Bolsa 3",
                "CARTA DE PORTE": "0001-00000002",
                "CONTRATISTA": "Contratista B",
                "TOLVA": "Tolva 02",
                "PESO HUMEDO Kg": "28700"
            }
        ];

        const parseCSVLine = (text) => {
            let p = '', row = [''], r = 0, s = true, l;
            for (l of text) {
                if ('"' === l) { if (s && l === p) row[r] += l; s = !s; }
                else if (',' === l && s) l = row[++r] = '';
                else row[r] += l; p = l;
            }
            return row;
        };

        const parseDateStrict = (str) => {
            if(!str) return null; 
            const s = str.replace(/-/g, '/'); 
            const parts = s.split('/'); 
            if (parts.length !== 3) return null; 
            let d, m, y; 
            if (parts[0].length === 4) { y = parseInt(parts[0]); m = parseInt(parts[1]) - 1; d = parseInt(parts[2]); } 
            else { d = parseInt(parts[0]); m = parseInt(parts[1]) - 1; y = parseInt(parts[2]); } 
            const date = new Date(y, m, d); 
            return isNaN(date.getTime()) ? null : date;
        };

        const runInternalTests = () => {
            try {
                console.assert(JSON.stringify(parseCSVLine('a,b,c')) === JSON.stringify(['a','b','c']), 'parseCSVLine simple');
                console.assert(JSON.stringify(parseCSVLine('"a,b",c')) === JSON.stringify(['"a,b"','c']), 'parseCSVLine quoted');
                console.assert(JSON.stringify(parseCSVLine('')) === JSON.stringify(['']), 'parseCSVLine vacío');
                const d1 = parseDateStrict('2025-11-28');
                console.assert(d1 instanceof Date && d1.getFullYear() === 2025, 'parseDateStrict ISO');
                const d2 = parseDateStrict('28/11/2025');
                console.assert(d2 instanceof Date && d2.getMonth() === 10, 'parseDateStrict ES');
                console.assert(parseDateStrict('') === null, 'parseDateStrict vacío');
                console.assert(Array.isArray(SAMPLE_ROWS) && SAMPLE_ROWS.length >= 2, 'SAMPLE_ROWS definido');
                console.log('[AGDP] Internal tests OK');
            } catch (e) {
                console.warn('[AGDP] Internal tests FAILED', e);
            }
        };
        runInternalTests();

        const KPICard = ({ label, value, subtext, icon, onClick, activeUnit }) => (
            <div className={`kpi-card ${onClick ? 'clickable' : ''}`} onClick={onClick}>
                <div className="kpi-header">
                    <div className="kpi-label">{icon} {label}</div>
                    {onClick && (
                        <div className="unit-badge">
                            {activeUnit} <Icons.ArrowUpDown size={10} />
                        </div>
                    )}
                </div>
                <div className="kpi-value">{value}</div>
                <div className="kpi-sub">{subtext}</div>
            </div>
        );

        const SimpleBarChart = ({ data, unit }) => {
            if (!data || data.length === 0) return <div className="no-data">Sin datos</div>;
            const maxVal = Math.max(...data.map(d => d.value));
            return (
                <div className="chart-container">
                    {data.slice(0, 8).map((item, idx) => (
                        <div key={idx} className="bar-row">
                            <div className="bar-label" title={item.label}>{item.label}</div>
                            <div className="bar-track">
                                <div 
                                    className="bar-fill" 
                                    style={{ 
                                        width: `${(item.value / maxVal) * 100}%`,
                                        backgroundColor: `hsl(${160 + (idx * 20)}, 40%, 40%)`
                                    }}
                                ></div>
                            </div>
                            <div className="bar-val">
                                {(unit === 'TON' ? (item.value/1000).toFixed(0) : item.value.toFixed(0))} {unit === 'TON' ? 't' : 'kg'}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const RankingList = ({ data, unit }) => {
            if (!data || data.length === 0) return <div className="no-data">Sin datos</div>;
            return (
                <div className="list-container">
                    {data.slice(0, 8).map((item, idx) => (
                        <div key={idx} className="list-item">
                            <div className="list-label" title={item.label}>{item.label}</div>
                            <div className="list-val">
                                {(unit === 'TON' ? (item.value/1000).toFixed(1) : item.value.toLocaleString())} {unit === 'TON' ? 't' : 'kg'}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const ProfileModal = ({ isOpen, onClose, user, onSave }) => {
            const [formData, setFormData] = useState({ ...user });
            const [showPass, setShowPass] = useState({ old: false, new: false, confirm: false });

            if (!isOpen) return null;

            return (
                <div className="modal-overlay">
                    <div className="modal-card">
                        <div className="modal-header">
                            <h3>Mi Perfil</h3>
                            <button className="btn-icon" onClick={onClose}><Icons.X size={20}/></button>
                        </div>
                        <div className="form-grid">
                            <div className="form-group">
                                <label className="form-label">Nombre</label>
                                <input value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="form-input" />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Apellido</label>
                                <input value={formData.lastname} onChange={e => setFormData({...formData, lastname: e.target.value})} className="form-input" />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Email</label>
                                <input value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} className="form-input" />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Teléfono</label>
                                <input value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} className="form-input" />
                            </div>
                            
                            <div className="section-title" style={{marginTop:'1rem'}}>Cambiar Contraseña</div>
                            {['old', 'new', 'confirm'].map(field => (
                                <div className="form-group" key={field}>
                                    <label className="form-label">{field === 'old' ? 'Clave Anterior' : field === 'new' ? 'Nueva Clave' : 'Confirmar'}</label>
                                    <div className="password-wrapper">
                                        <input type={showPass[field] ? "text" : "password"} className="form-input" style={{paddingRight: '2.5rem'}} />
                                        <button type="button" className="toggle-pass-btn" onClick={() => setShowPass({...showPass, [field]: !showPass[field]})}>
                                            {showPass[field] ? <Icons.EyeOff size={16}/> : <Icons.Eye size={16}/>}
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="modal-footer">
                            <button className="btn btn-outline" onClick={onClose}>Cancelar</button>
                            <button className="btn btn-primary" onClick={() => onSave(formData)}>Guardar Perfil</button>
                        </div>
                    </div>
                </div>
            );
        };

        const MapModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="modal-overlay">
                    <div className="modal-card modal-lg" style={{height:'80vh'}}>
                        <div className="modal-header">
                            <h3>Geolocalización</h3>
                            <button className="btn-icon" onClick={onClose}><Icons.X size={20}/></button>
                        </div>
                        <div style={{flex:1, background:'#e2e8f0', display:'flex', alignItems:'center', justifyContent:'center', flexDirection:'column', color:'var(--text-light)'}}>
                            <Icons.MapPin size={48} opacity={0.5} />
                            <p>Mapa Global de Descargas</p>
                            <span style={{fontSize:'0.8rem'}}>(Vista de Mapa Simulada)</span>
                        </div>
                    </div>
                </div>
            );
        };

        /* VISTA ESTABLECIMIENTOS (módulo completo integrado) */
        const EstablecimientosView = () => {
            const [filterProducer, setFilterProducer] = useState('');
            const [filterEst, setFilterEst] = useState('');
            const [editingCell, setEditingCell] = useState({ id: null, value: '' });

            const [data, setData] = useState([
                {
                    id: 1,
                    code: 'EST001-AR',
                    name: 'La Estancia',
                    owner: 'Propietario Prueba',
                    country: 'Argentina',
                    province: 'Córdoba',
                    city: 'Río Cuarto',
                    agreement: 'CONV-2023-A',
                    sendToTablet: true,
                    expanded: true,
                    lots: [
                        { id: 101, code: 'L001-N', name: 'Lote Norte', hectares: 150, sendToTablet: true },
                        { id: 102, code: 'L002-S', name: 'Lote Sur', hectares: 85.5, sendToTablet: false }
                    ]
                },
                {
                    id: 2,
                    code: 'EST002-BA',
                    name: 'El Trébol',
                    owner: 'Juan Pérez',
                    country: 'Argentina',
                    province: 'Buenos Aires',
                    city: 'Tandil',
                    agreement: '',
                    sendToTablet: false,
                    expanded: false,
                    lots: [
                        { id: 201, code: 'L003-A', name: 'Lote Ruta', hectares: 200, sendToTablet: true }
                    ]
                }
            ]);

            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalMode, setModalMode] = useState('EST'); 
            const [currentItem, setCurrentItem] = useState(null);
            const [parentId, setParentId] = useState(null);
            const [showAdvanced, setShowAdvanced] = useState(false);

            const locationData = {
                'Argentina': {
                    'Córdoba': ['Córdoba Capital', 'Río Cuarto', 'Villa Carlos Paz'],
                    'Buenos Aires': ['La Plata', 'Tandil', 'Bahía Blanca']
                }
            };

            const startEditing = (lot) => {
                setEditingCell({ id: lot.id, value: lot.hectares });
            };

            const saveEditing = (estId, lotId) => {
                const newValue = parseFloat(editingCell.value);
                const finalValue = isNaN(newValue) ? 0 : newValue;

                setData(prev => prev.map(est => {
                    if (est.id !== estId) return est;
                    return {
                        ...est,
                        lots: est.lots.map(l => l.id === lotId ? { ...l, hectares: finalValue } : l)
                    };
                }));
                setEditingCell({ id: null, value: '' });
            };

            const handleKeyDown = (e, estId, lotId) => {
                if (e.key === 'Enter') saveEditing(estId, lotId);
                if (e.key === 'Escape') setEditingCell({ id: null, value: '' });
            };

            const toggleExpand = (id) => {
                setData(prev => prev.map(item => item.id === id ? {...item, expanded: !item.expanded} : item));
            };

            const toggleTablet = (estId, lotId = null) => {
                setData(prev => prev.map(est => {
                    if (est.id !== estId) return est;
                    if (lotId === null) {
                        return { ...est, sendToTablet: !est.sendToTablet };
                    } else {
                        return {
                            ...est,
                            lots: est.lots.map(l => l.id === lotId ? {...l, sendToTablet: !l.sendToTablet} : l)
                        };
                    }
                }));
            };

            const handleDelete = (estId, lotId = null) => {
                if (!confirm("¿Seguro que desea eliminar este registro?")) return;
                if (lotId === null) {
                    setData(prev => prev.filter(p => p.id !== estId));
                } else {
                    setData(prev => prev.map(est => {
                        if (est.id !== estId) return est;
                        return { ...est, lots: est.lots.filter(l => l.id !== lotId) };
                    }));
                }
            };

            const openModal = (mode, item = null, parent = null) => {
                setModalMode(mode);
                setParentId(parent);
                
                if (item) {
                    setCurrentItem({...item});
                    if (mode === 'EST' && item.agreement) setShowAdvanced(true);
                    else setShowAdvanced(false);
                } else {
                    if (mode === 'EST') {
                        setCurrentItem({ code: '', name: '', owner: 'Propietario Prueba', country: 'Argentina', province: '', city: '', agreement: '', sendToTablet: true });
                    } else {
                        setCurrentItem({ code: '', name: '', hectares: '', sendToTablet: true });
                    }
                    setShowAdvanced(false);
                }
                setIsModalOpen(true);
            };

            const handleSave = () => {
                if (!currentItem.code || !currentItem.name) return alert("Código y Nombre requeridos");
                if (currentItem.code.length > 12) return alert("Código máx 12 caracteres");
                if (currentItem.name.length > 25) return alert("Nombre máx 25 caracteres");

                if (modalMode === 'EST') {
                    if (currentItem.id) {
                        setData(prev => prev.map(est => est.id === currentItem.id ? { ...est, ...currentItem } : est));
                    } else {
                        const newEst = { ...currentItem, id: Date.now(), lots: [], expanded: true };
                        setData(prev => [...prev, newEst]);
                    }
                } else {
                    const lotData = { ...currentItem, hectares: parseFloat(currentItem.hectares) || 0 };
                    
                    if (currentItem.id) {
                        setData(prev => prev.map(est => {
                            if (est.id !== parentId) return est;
                            return { ...est, lots: est.lots.map(l => l.id === currentItem.id ? { ...l, ...lotData } : l) };
                        }));
                    } else {
                        setData(prev => prev.map(est => {
                            if (est.id !== parentId) return est;
                            return { ...est, lots: [...est.lots, { ...lotData, id: Date.now() }] };
                        }));
                    }
                }
                setIsModalOpen(false);
            };

            const filteredData = useMemo(() => (
                data.filter(item => {
                    const matchProd = filterProducer ? item.owner.toLowerCase().includes(filterProducer.toLowerCase()) : true;
                    const matchEst = filterEst ? item.name.toLowerCase().includes(filterEst.toLowerCase()) : true;
                    return matchProd && matchEst;
                })
            ), [data, filterProducer, filterEst]);

            const TooltipInfo = () => (
                <span className="tooltip-container">
                    <Icons.Info size={14} color="var(--info)" />
                    <span className="tooltip-text">
                        Si está activo, este campo aparecerá disponible para elegir en la tablet. Si está desactivado, no se podrá elegir.
                    </span>
                </span>
            );

            const TabletToggle = ({ checked, onChange, textOn, textOff }) => (
                <span className="tooltip-container" style={{margin:0}}>
                    <label className="toggle-switch">
                        <input type="checkbox" checked={checked} onChange={onChange} />
                        <span className="slider"></span>
                    </label>
                    <span className="tooltip-text">
                        {checked ? textOn : textOff}
                    </span>
                </span>
            );

            return (
                <div className="dashboard-content">
                    <div style={{ maxWidth: '1200px', margin: '0 auto', width:'100%' }}>
                        <div className="filters-panel" style={{borderBottomLeftRadius:0, borderBottomRightRadius:0, marginBottom:0}}>
                            <h2 className="section-title" style={{border:'none', paddingBottom:0, marginBottom:'0.75rem'}}>Establecimientos y Lotes</h2>
                            <div className="filters-row">
                                <input 
                                    placeholder="Filtrar por Productor/Dueño..." 
                                    className="form-input" 
                                    style={{flex:1, minWidth:'200px', background:'var(--surface)'}}
                                    value={filterProducer}
                                    onChange={e => setFilterProducer(e.target.value)}
                                />
                                <input 
                                    placeholder="Filtrar por Establecimiento..." 
                                    className="form-input" 
                                    style={{flex:1, minWidth:'200px', background:'var(--surface)'}}
                                    value={filterEst}
                                    onChange={e => setFilterEst(e.target.value)}
                                />
                                <div style={{flex:'0 0 auto'}}>
                                    <button className="btn btn-primary" onClick={() => openModal('EST')}>
                                        <Icons.Plus size={18}/> Nuevo Establecimiento
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="table-wrapper" style={{borderTopLeftRadius:0, borderTopRightRadius:0}}>
                            <table className="data-table">
                                <thead>
                                    <tr>
                                        <th style={{width:40}}></th>
                                        <th>Código</th>
                                        <th>Nombre</th>
                                        <th>Ubicación / Hectáreas</th>
                                        <th>Propietario</th>
                                        <th className="text-center">
                                            <div style={{display:'flex', alignItems:'center', justifyContent:'center', gap:4}}>
                                                Tablet <TooltipInfo />
                                            </div>
                                        </th>
                                        <th className="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredData.map(est => (
                                        <React.Fragment key={est.id}>
                                            <tr style={{background: '#fff'}}>
                                                <td className="text-center" style={{cursor:'pointer'}} onClick={() => toggleExpand(est.id)}>
                                                    {est.expanded ? <Icons.ChevronDown size={18} color="var(--primary)"/> : <Icons.ChevronRight size={18} color="var(--text-light)"/>}
                                                </td>
                                                <td style={{fontWeight:600}}>
                                                    {est.code}
                                                    {est.agreement && (
                                                        <span 
                                                            title={`Convenio: ${est.agreement}`} 
                                                            style={{display:'inline-block', width:6, height:6, background:'var(--info)', borderRadius:'50%', marginLeft:6, verticalAlign:'top'}}
                                                        ></span>
                                                    )}
                                                </td>
                                                <td style={{fontWeight:600, color:'var(--primary)'}}>{est.name}</td>
                                                <td style={{fontSize:'0.8rem', color:'var(--text-light)'}}>
                                                    {est.city && est.province ? `${est.city}, ${est.province}` : est.province || est.city || '-'}
                                                </td>
                                                <td><span className="owner-badge">{est.owner}</span></td>
                                                <td className="text-center">
                                                    <TabletToggle 
                                                        checked={est.sendToTablet} 
                                                        onChange={() => toggleTablet(est.id)}
                                                        textOn="Activo: Disponible en Tablet"
                                                        textOff="Inactivo: No visible en Tablet"
                                                    />
                                                </td>
                                                <td className="text-center">
                                                    <div style={{display:'flex', justifyContent:'center', gap:4}}>
                                                        <button className="btn-icon" title="Agregar Lote" onClick={() => openModal('LOT', null, est.id)}>
                                                            <Icons.Plus size={16} color="var(--primary)"/>
                                                        </button>
                                                        <button className="btn-icon" title="Editar" onClick={() => openModal('EST', est)}>
                                                            <Icons.Edit2 size={16}/>
                                                        </button>
                                                        <button className="btn-icon" title="Eliminar" onClick={() => handleDelete(est.id)}>
                                                            <Icons.Trash2 size={16} color="var(--danger)"/>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>

                                            {est.expanded && (
                                                <>
                                                    {est.lots.length === 0 && (
                                                        <tr>
                                                            <td colSpan="7" style={{padding:'1rem', textAlign:'center', fontStyle:'italic', color:'var(--text-light)', background:'#f8fafc', borderBottom:'1px dashed var(--border)'}}>
                                                                No hay lotes cargados para {est.name}.
                                                            </td>
                                                        </tr>
                                                    )}
                                                    {est.lots.map(lot => (
                                                        <tr key={lot.id} style={{background: '#f8fafc'}}>
                                                            <td style={{borderRight:'3px solid var(--primary)'}}></td>
                                                            <td style={{paddingLeft:'1.5rem', fontSize:'0.85rem', color:'var(--text-light)', fontFamily:'monospace'}}>└ {lot.code}</td>
                                                            <td style={{fontSize:'0.85rem', fontWeight:500}}>{lot.name}</td>
                                                            
                                                            <td 
                                                                style={{verticalAlign:'middle', cursor: 'text'}}
                                                                onClick={() => startEditing(lot)}
                                                                title="Click para editar hectáreas"
                                                            >
                                                                {editingCell.id === lot.id ? (
                                                                    <input 
                                                                        type="number"
                                                                        autoFocus
                                                                        step="0.01"
                                                                        className="form-input"
                                                                        style={{height: '28px', width: '100px', padding: '0 0.5rem', fontSize:'0.85rem', background:'var(--surface)'}}
                                                                        value={editingCell.value}
                                                                        onChange={(e) => setEditingCell({ ...editingCell, value: e.target.value })}
                                                                        onBlur={() => saveEditing(est.id, lot.id)}
                                                                        onKeyDown={(e) => handleKeyDown(e, est.id, lot.id)}
                                                                        onClick={(e) => e.stopPropagation()} 
                                                                    />
                                                                ) : (
                                                                    lot.hectares > 0 ? (
                                                                        <span className="ha-badge" style={{cursor:'pointer', transition:'background 0.2s'}}>
                                                                            <Icons.Layout size={12}/> {lot.hectares} ha <Icons.Edit2 size={10} style={{opacity:0.5, marginLeft:4}}/>
                                                                        </span>
                                                                    ) : (
                                                                        <span style={{fontSize:'0.75rem', color:'#94a3b8', borderBottom:'1px dashed #cbd5e1', cursor:'pointer'}}>
                                                                            + Agregar Ha
                                                                        </span>
                                                                    )
                                                                )}
                                                            </td>

                                                            <td></td>
                                                            <td className="text-center">
                                                                <TabletToggle 
                                                                    checked={lot.sendToTablet}
                                                                    onChange={() => toggleTablet(est.id, lot.id)}
                                                                    textOn="Lote visible en Tablet"
                                                                    textOff="Lote oculto en Tablet"
                                                                />
                                                            </td>
                                                            <td className="text-center">
                                                                <div style={{display:'flex', justifyContent:'center', gap:4}}>
                                                                    <button className="btn-icon" onClick={() => openModal('LOT', lot, est.id)} title="Editar Lote">
                                                                        <Icons.Edit2 size={14}/>
                                                                    </button>
                                                                    <button className="btn-icon" onClick={() => handleDelete(est.id, lot.id)} title="Eliminar Lote">
                                                                        <Icons.Trash2 size={14} color="var(--danger)"/>
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                    <tr style={{height:10}}></tr> 
                                                </>
                                            )}
                                        </React.Fragment>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {isModalOpen && currentItem && (
                        <div className="modal-overlay">
                            <div className="modal-card">
                                <div className="modal-header">
                                    <h3>{currentItem.id ? 'Editar' : 'Nuevo'} {modalMode === 'EST' ? 'Establecimiento' : 'Lote'}</h3>
                                    <button className="btn-icon" onClick={() => setIsModalOpen(false)}><Icons.X size={20}/></button>
                                </div>
                                <div className="form-grid">
                                    <div className="form-group">
                                        <label className="form-label">Código (Único, máx 12)</label>
                                        <input 
                                            maxLength={12}
                                            className="form-input" 
                                            value={currentItem.code} 
                                            onChange={e => setCurrentItem({...currentItem, code: e.target.value.toUpperCase()})}
                                            placeholder="Ej: EST-001"
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Nombre (Máx 25)</label>
                                        <input 
                                            maxLength={25}
                                            className="form-input" 
                                            value={currentItem.name} 
                                            onChange={e => setCurrentItem({...currentItem, name: e.target.value})}
                                            placeholder="Nombre descriptivo"
                                        />
                                    </div>

                                    {modalMode === 'EST' ? (
                                        <>
                                            <div className="form-group">
                                                <label className="form-label">Propietario</label>
                                                <select 
                                                    className="form-select" 
                                                    value={currentItem.owner} 
                                                    onChange={e => setCurrentItem({...currentItem, owner: e.target.value})}
                                                >
                                                    <option value="Propietario Prueba">Propietario Prueba</option>
                                                    <option value="Juan Pérez">Juan Pérez</option>
                                                    <option value="Agrícola S.A.">Agrícola S.A.</option>
                                                </select>
                                            </div>
                                            <div style={{display:'flex', gap:'1rem'}}>
                                                <div className="form-group" style={{flex:1}}>
                                                    <label className="form-label">País</label>
                                                    <select className="form-select" value={currentItem.country} disabled>
                                                        <option>Argentina</option>
                                                    </select>
                                                </div>
                                                <div className="form-group" style={{flex:1}}>
                                                    <label className="form-label">Provincia</label>
                                                    <select 
                                                        className="form-select" 
                                                        value={currentItem.province} 
                                                        onChange={e => setCurrentItem({...currentItem, province: e.target.value, city: ''})}
                                                    >
                                                        <option value="">Seleccionar...</option>
                                                        {Object.keys(locationData['Argentina']).map(p => (
                                                            <option key={p} value={p}>{p}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Ciudad</label>
                                                <select 
                                                    className="form-select" 
                                                    value={currentItem.city} 
                                                    onChange={e => setCurrentItem({...currentItem, city: e.target.value})}
                                                    disabled={!currentItem.province}
                                                >
                                                    <option value="">Seleccionar...</option>
                                                    {currentItem.province && locationData['Argentina'][currentItem.province].map(c => (
                                                        <option key={c} value={c}>{c}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            <div style={{marginTop: '0.5rem', borderTop:'1px dashed var(--border)', paddingTop:'0.5rem'}}>
                                                <button 
                                                    onClick={() => setShowAdvanced(!showAdvanced)}
                                                    style={{background:'none', border:'none', color:'var(--primary)', fontSize:'0.8rem', cursor:'pointer', display:'flex', alignItems:'center', gap:'0.25rem', padding:0, fontWeight:500}}
                                                >
                                                    {showAdvanced ? <Icons.ChevronDown size={16}/> : <Icons.ChevronRight size={16}/> }
                                                    Opciones Avanzadas
                                                </button>
                                            </div>

                                            {showAdvanced && (
                                                <div className="form-group" style={{marginTop:'0.5rem', animation:'fadeIn 0.2s'}}>
                                                    <label className="form-label">Convenio (Opcional)</label>
                                                    <input 
                                                        className="form-input" 
                                                        value={currentItem.agreement || ''} 
                                                        onChange={e => setCurrentItem({...currentItem, agreement: e.target.value})}
                                                        placeholder="Código o nombre de convenio"
                                                    />
                                                    <small style={{fontSize:'0.7rem', color:'var(--text-light)'}}>
                                                        Uso exclusivo para clientes con convenio especial de acopio.
                                                    </small>
                                                </div>
                                            )}
                                        </>
                                    ) : (
                                        <div className="form-group">
                                            <label className="form-label">Hectáreas</label>
                                            <div style={{position:'relative'}}>
                                                <input 
                                                    type="number"
                                                    step="0.01"
                                                    className="form-input" 
                                                    style={{paddingLeft: '32px', background:'var(--surface)'}}
                                                    value={currentItem.hectares} 
                                                    onChange={e => setCurrentItem({...currentItem, hectares: e.target.value})}
                                                    placeholder="0.00"
                                                />
                                                <div style={{position:'absolute', left:10, top:10, color:'var(--text-light)'}}>
                                                    <Icons.Layout size={16}/>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    <div className="form-group" style={{marginTop:'1rem', background:'#f1f5f9', padding:'1rem', borderRadius:'6px'}}>
                                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                            <label style={{fontSize:'0.9rem', fontWeight:600}}>Disponible en Tablet</label>
                                            <label className="toggle-switch">
                                                <input 
                                                    type="checkbox" 
                                                    checked={currentItem.sendToTablet} 
                                                    onChange={e => setCurrentItem({...currentItem, sendToTablet: e.target.checked})} 
                                                />
                                                <span className="slider"></span>
                                            </label>
                                        </div>
                                        <p style={{fontSize:'0.75rem', color:'var(--text-light)', marginTop:'0.5rem'}}>
                                            Activa esta opción para que este {modalMode === 'EST' ? 'establecimiento' : 'lote'} aparezca disponible para elegir en la aplicación móvil.
                                        </p>
                                    </div>
                                </div>
                                <div className="modal-footer">
                                    <button className="btn btn-outline" onClick={() => setIsModalOpen(false)}>Cancelar</button>
                                    <button className="btn btn-primary" onClick={handleSave}>Guardar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const DashboardContent = () => {
            const [rawData, setRawData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [activeSheet] = useState(URL_MANIAGRO);
            const [showMap, setShowMap] = useState(false);
            const [loadError, setLoadError] = useState(null);
            
            const [filters, setFilters] = useState({
                dateFrom: '', dateTo: '',
                est: '', lote: '', prod: '', tolva: '', productor: '', contratista: '',
                destinationType: 'ALL',
                hideLow: true,
                groupBy: ''
            });

            const [displayUnit, setDisplayUnit] = useState('TON');

            useEffect(() => {
                const fetchData = async () => {
                    setLoading(true);
                    setLoadError(null);
                    try {
                        const match = activeSheet.match(/\/d\/([a-zA-Z0-9-_]+)/);
                        if (!match) throw new Error("URL inválida para Google Sheets");
                        const csvUrl = `https://docs.google.com/spreadsheets/d/${match[1]}/export?format=csv`;
                        const response = await fetch(csvUrl, { method: 'GET' });
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status} al intentar obtener CSV`);
                        }
                        const text = await response.text();
                        if (!text) throw new Error('Respuesta CSV vacía');
                        const lines = text.split('\n').filter(l => l.trim().length > 0);
                        if (lines.length === 0) throw new Error('CSV sin líneas de datos');
                        const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                        const parsed = lines.slice(1).map((line, idx) => {
                            const vals = parseCSVLine(line);
                            const obj = { id: idx };
                            headers.forEach((h, i) => obj[h] = (vals[i] || '').trim().replace(/^"|"$/g, ''));
                            obj.PESO_NUM = parseFloat(obj['PESO HUMEDO Kg']) || 0;
                            obj.DATE_OBJ = parseDateStrict(obj['FECHA PESADA']);
                            return obj;
                        });
                        setRawData(parsed);
                    } catch (err) {
                        console.warn('[AGDP] No se pudo cargar Google Sheets en este entorno. Usando datos de ejemplo.', err);
                        setLoadError('No se pudo conectar con Google Sheets. Se están usando datos de ejemplo para la vista.');
                        const fallback = SAMPLE_ROWS.map((row, idx) => ({
                            ...row,
                            id: idx,
                            PESO_NUM: parseFloat(row['PESO HUMEDO Kg']) || 0,
                            DATE_OBJ: parseDateStrict(row['FECHA PESADA'])
                        }));
                        setRawData(fallback);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchData();
            }, [activeSheet]);

            const filteredData = useMemo(() => {
                return rawData.filter(row => {
                    if (filters.hideLow && row.PESO_NUM < 100) return false;
                    if (filters.dateFrom) {
                        const from = new Date(filters.dateFrom);
                        if (row.DATE_OBJ && row.DATE_OBJ < from) return false;
                    }
                    if (filters.dateTo) {
                        const to = new Date(filters.dateTo);
                        to.setHours(23,59,59);
                        if (row.DATE_OBJ && row.DATE_OBJ > to) return false;
                    }
                    if (filters.est && row['ESTABLECIMIENTO'] !== filters.est) return false;
                    if (filters.lote && row['LOTE'] !== filters.lote) return false;
                    if (filters.prod && row['PRODUCTO'] !== filters.prod) return false;
                    if (filters.productor && row['PRODUCTOR'] !== filters.productor) return false;
                    if (filters.contratista && row['CONTRATISTA'] !== filters.contratista) return false;
                    if (filters.tolva && row['TOLVA'] !== filters.tolva) return false;
                    
                    if (filters.destinationType !== 'ALL') {
                        const dest = (row['DESTINO DESCARGA'] || '').toUpperCase();
                        const isSilo = dest.includes('SILO') || dest.includes('BOLSA');
                        if (filters.destinationType === 'SILO' && !isSilo) return false;
                        if (filters.destinationType === 'TRUCK' && isSilo) return false;
                    }
                    return true;
                });
            }, [rawData, filters]);

            const displayData = useMemo(() => {
                if (!filters.groupBy) return filteredData;
                const groups = {};
                filteredData.forEach(row => {
                    const key = row['DESTINO DESCARGA'] || 'Sin Destino';
                    if (!groups[key]) groups[key] = { ...row, count: 0, PESO_NUM: 0, isGroup: true };
                    groups[key].count += 1;
                    groups[key].PESO_NUM += row.PESO_NUM;
                });
                return Object.values(groups);
            }, [filteredData, filters.groupBy]);

            const kpis = useMemo(() => {
                let truckC = 0, truckW = 0, siloC = 0, siloW = 0;
                filteredData.forEach(r => {
                    const dest = (r['DESTINO DESCARGA'] || '').toUpperCase();
                    const isSilo = dest.includes('SILO') || dest.includes('BOLSA');
                    if (isSilo) { siloC++; siloW += r.PESO_NUM; }
                    else { truckC++; truckW += r.PESO_NUM; }
                });
                return { truckC, truckW, siloC, siloW };
            }, [filteredData]);

            const chartDataEst = useMemo(() => {
                const map = {};
                filteredData.forEach(r => { const k = r['ESTABLECIMIENTO'] || 'Sin Datos'; map[k] = (map[k] || 0) + r.PESO_NUM; });
                return Object.entries(map).sort((a,b) => b[1] - a[1]).map(([label, value]) => ({ label, value }));
            }, [filteredData]);

            const listDataTolva = useMemo(() => {
                const map = {};
                filteredData.forEach(r => { const k = r['TOLVA'] || '-'; map[k] = (map[k] || 0) + r.PESO_NUM; });
                return Object.entries(map).sort((a,b) => b[1] - a[1]).map(([label, value]) => ({ label, value }));
            }, [filteredData]);

            const listDataContratista = useMemo(() => {
                const map = {};
                filteredData.forEach(r => { const k = r['CONTRATISTA'] || '-'; map[k] = (map[k] || 0) + r.PESO_NUM; });
                return Object.entries(map).sort((a,b) => b[1] - a[1]).map(([label, value]) => ({ label, value }));
            }, [filteredData]);

            const getOptions = (key) => [...new Set(rawData.map(r => r[key]).filter(Boolean))].sort();

            return (
                <div className="dashboard-content">
                    <div className="kpi-grid">
                        <KPICard label="Camiones" icon={<IconTolva size={18} />} value={kpis.truckC} subtext="Viajes" />
                        <KPICard 
                            label="Volumen Camión" 
                            icon={<Icons.Download size={18} />} 
                            value={displayUnit === 'TON' ? (kpis.truckW/1000).toFixed(1) : kpis.truckW.toLocaleString()} 
                            subtext={displayUnit === 'TON' ? 'Toneladas' : 'Kg Húmedo'} 
                            onClick={() => setDisplayUnit(prev => prev === 'TON' ? 'KG' : 'TON')} 
                            activeUnit={displayUnit} 
                        />
                        <KPICard label="Silos" icon={<Icons.Layers size={18} />} value={kpis.siloC} subtext="Cargas" />
                        <KPICard 
                            label="Volumen Silo" 
                            icon={<IconCosechadora size={18} />} 
                            value={displayUnit === 'TON' ? (kpis.siloW/1000).toFixed(1) : kpis.siloW.toLocaleString()} 
                            subtext={displayUnit === 'TON' ? 'Toneladas' : 'Kg Húmedo'} 
                            onClick={() => setDisplayUnit(prev => prev === 'TON' ? 'KG' : 'TON')} 
                            activeUnit={displayUnit} 
                        />
                    </div>

                    <div className="filters-panel">
                        {loadError && (
                            <div style={{
                                background:'#fef3c7',
                                border:'1px solid #facc15',
                                color:'#92400e',
                                padding:'0.5rem 0.75rem',
                                borderRadius:'6px',
                                fontSize:'0.8rem',
                                marginBottom:'0.5rem'
                            }}>
                                {loadError}
                            </div>
                        )}

                        <div className="filters-row">
                            <div className="date-input-wrapper">
                                <span>Desde:</span> 
                                <input type="date" className="form-input" onChange={e => setFilters({...filters, dateFrom: e.target.value})} />
                            </div>
                            <div className="date-input-wrapper">
                                <span>Hasta:</span> 
                                <input type="date" className="form-input" onChange={e => setFilters({...filters, dateTo: e.target.value})} />
                            </div>
                            
                            <select className="form-select" onChange={e => setFilters({...filters, productor: e.target.value})}>
                                <option value="">Productor...</option>
                                {getOptions('PRODUCTOR').map(o => <option key={o} value={o}>{o}</option>)}
                            </select>
                            <select className="form-select" onChange={e => setFilters({...filters, est: e.target.value})}>
                                <option value="">Establecimiento...</option>
                                {getOptions('ESTABLECIMIENTO').map(o => <option key={o} value={o}>{o}</option>)}
                            </select>
                            <select className="form-select" onChange={e => setFilters({...filters, lote: e.target.value})}>
                                <option value="">Lote...</option>
                                {getOptions('LOTE').map(o => <option key={o} value={o}>{o}</option>)}
                            </select>
                            <select className="form-select" onChange={e => setFilters({...filters, contratista: e.target.value})}>
                                <option value="">Contratista...</option>
                                {getOptions('CONTRATISTA').map(o => <option key={o} value={o}>{o}</option>)}
                            </select>
                            <select className="form-select" onChange={e => setFilters({...filters, tolva: e.target.value})}>
                                <option value="">Tolva...</option>
                                {getOptions('TOLVA').map(o => <option key={o} value={o}>{o}</option>)}
                            </select>

                            <div className="btn-group">
                                <button className={`btn-group-item ${filters.destinationType === 'ALL' ? 'active' : ''}`} onClick={() => setFilters({...filters, destinationType: 'ALL'})}>Todos</button>
                                <button className={`btn-group-item ${filters.destinationType === 'TRUCK' ? 'active' : ''}`} onClick={() => setFilters({...filters, destinationType: 'TRUCK'})}>
                                    <IconTolva size={14}/> Camión
                                </button>
                                <button className={`btn-group-item ${filters.destinationType === 'SILO' ? 'active' : ''}`} onClick={() => setFilters({...filters, destinationType: 'SILO'})}>
                                    <Icons.Layers size={14}/> Silo
                                </button>
                            </div>
                            
                            <label style={{fontSize:'0.8rem', display:'flex', alignItems:'center', gap:'0.5rem', cursor:'pointer'}}>
                                <input type="checkbox" checked={filters.hideLow} onChange={e => setFilters({...filters, hideLow: e.target.checked})} />
                                Ocultar &lt; 100kg
                            </label>
                        </div>
                        
                        <div className="actions-row">
                            <div style={{display:'flex', gap:'0.5rem', alignItems:'center'}}>
                                <span style={{fontSize:'0.8rem', fontWeight:'600', color:'var(--text-light)'}}>AGRUPAR:</span>
                                <button 
                                    className={`btn ${filters.groupBy === 'DESTINO' ? 'btn-primary' : 'btn-outline'}`} 
                                    onClick={() => setFilters(f => ({...f, groupBy: f.groupBy ? '' : 'DESTINO'}))}
                                >
                                    <Icons.Grid size={14} style={{marginRight:4}}/> Destinos
                                </button>
                                <button 
                                    className="btn btn-outline-danger" 
                                    onClick={() => setFilters({dateFrom:'', dateTo:'', est:'', lote:'', prod:'', tolva:'', productor:'', contratista:'', destinationType:'ALL', hideLow:true, groupBy:''})} 
                                    title="Limpiar Filtros"
                                >
                                    <Icons.Trash2 size={16}/>
                                </button>
                            </div>
                            
                            <div style={{display:'flex', gap:'0.5rem'}}>
                                <button className="btn btn-outline" title="Exportar CSV"><Icons.FileSpreadsheet size={18}/></button>
                                <button className="btn btn-outline" title="Exportar PDF"><Icons.FileText size={18}/></button>
                                <button className="btn btn-outline" title="Pantalla Completa"><Icons.Maximize size={18}/></button>
                                <button className="btn btn-primary" onClick={() => setShowMap(true)}>
                                    <Icons.Map size={18} style={{marginRight:4}}/> Ver Mapa Global
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="stats-layout">
                        <div className="table-wrapper">
                            {loading ? (
                                <div style={{padding:'2rem', textAlign:'center'}}>Cargando datos...</div>
                            ) : (
                                <table className="data-table">
                                    <thead>
                                        <tr>
                                            {!filters.groupBy && <th style={{width:30}}><input type="checkbox"/></th>}
                                            <th>Estado</th>
                                            <th>{filters.groupBy ? 'Grupo / Destino' : 'Fecha'}</th>
                                            {!filters.groupBy && <th>Hora</th>}
                                            {!filters.groupBy && <th>Productor</th>}
                                            {!filters.groupBy && <th>Establecimiento</th>}
                                            {!filters.groupBy && <th>Lote</th>}
                                            {!filters.groupBy && <th>Producto</th>}
                                            {!filters.groupBy && <th>Destino</th>}
                                            {!filters.groupBy && <th>C. Porte</th>}
                                            {!filters.groupBy && <th>Contratista</th>}
                                            {!filters.groupBy && <th>Tolva</th>}
                                            <th className="text-right">Peso ({displayUnit})</th>
                                            {!filters.groupBy && <th>Acciones</th>}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {displayData.slice(0, 100).map((row, idx) => (
                                            <tr key={idx} className={row.isGroup ? 'row-group' : ''}>
                                                {!filters.groupBy && <td><input type="checkbox"/></td>}
                                                <td className="text-center">
                                                    {row.isGroup ? (
                                                        <span className="badge-group">{row.count} Regs</span>
                                                    ) : (
                                                        row.PESO_NUM > 30000 ? 
                                                            <Icons.AlertTriangle size={16} color="var(--warning)" /> :
                                                            <div style={{width:8, height:8, borderRadius:'50%', background:'var(--success)', margin:'0 auto'}}></div>
                                                    )}
                                                </td>
                                                <td>{row.isGroup ? row['DESTINO DESCARGA'] : row['FECHA PESADA']}</td>
                                                {!filters.groupBy && <td>{row['HORA PESADA']}</td>}
                                                {!filters.groupBy && <td>{row['PRODUCTOR']}</td>}
                                                {!filters.groupBy && <td>{row['ESTABLECIMIENTO']}</td>}
                                                {!filters.groupBy && <td>{row['LOTE']}</td>}
                                                {!filters.groupBy && <td>{row['PRODUCTO']}</td>}
                                                {!filters.groupBy && <td>{row['DESTINO DESCARGA']}</td>}
                                                {!filters.groupBy && <td>{row['CARTA DE PORTE']}</td>}
                                                {!filters.groupBy && <td>{row['CONTRATISTA']}</td>}
                                                {!filters.groupBy && <td>{row['TOLVA']}</td>}
                                                <td className="text-right font-mono">
                                                    {displayUnit === 'TON' ? (row.PESO_NUM/1000).toFixed(2) : row.PESO_NUM.toLocaleString()}
                                                </td>
                                                {!filters.groupBy && (
                                                    <td className="text-center">
                                                        <button className="btn-icon"><Icons.Edit2 size={14}/></button>
                                                    </td>
                                                )}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>

                        <div className="charts-sidebar">
                            <div className="chart-card">
                                <h4>Totales por Establecimiento</h4>
                                <SimpleBarChart data={chartDataEst} unit={displayUnit} />
                            </div>
                            <div className="chart-card">
                                <h4>Ranking Tolvas</h4>
                                <RankingList data={listDataTolva} unit={displayUnit} />
                            </div>
                            <div className="chart-card">
                                <h4>Ranking Contratistas</h4>
                                <RankingList data={listDataContratista} unit={displayUnit} />
                            </div>
                        </div>
                    </div>
                    
                    <MapModal isOpen={showMap} onClose={() => setShowMap(false)} />
                </div>
            );
        };

        const Header = ({ darkMode, toggleDarkMode, toggleSidebar, user, onEditProfile }) => {
            const [showNotif, setShowNotif] = useState(false);
            const alerts = [
                { type: 'Modificación en Tolva', color: 'var(--info)', msg: 'El tolvero modificó humedad.', time: '14:30' },
                { type: 'Sobrepeso', color: 'var(--warning)', msg: 'Exceso de peso detectado.', time: '12:15' },
                { type: 'Descarga Defectuosa', color: 'var(--danger)', msg: 'Falla en sensor.', time: '10:45' }
            ];

            return (
                <header>
                    <div className="brand">
                        <button className="nav-icon-btn" onClick={toggleSidebar} style={{marginRight:'1rem'}}><Icons.Menu size={24}/></button>
                        <div className="logo-box">AG</div>
                        <h1>Descargas <span>| AGDP</span> <span className="version-badge">v4.23</span></h1>
                    </div>
                    <div className="header-actions">
                        <div className="user-type-badge">Productor: <strong>2218PH</strong></div>
                        <button className="nav-icon-btn" onClick={toggleDarkMode}>
                            {darkMode ? <Icons.Sun size={20}/> : <Icons.Moon size={20}/>}
                        </button>
                        
                        <div style={{position:'relative'}}>
                            <button className="nav-icon-btn" onClick={() => setShowNotif(!showNotif)}>
                                <Icons.Bell size={20}/> <span className="notif-dot"></span>
                            </button>
                            {showNotif && (
                                <div className="dropdown">
                                    <div className="dd-header">Alertas Recientes</div>
                                    {alerts.map((a,i) => (
                                        <div key={i} className="dd-item">
                                            <Icons.AlertOctagon size={14} color={a.color} style={{marginTop:2}}/>
                                            <div>
                                                <div style={{fontWeight:600}}>{a.type}</div>
                                                <div style={{fontSize:'0.8rem'}}>{a.msg}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        <button className="nav-icon-btn"><Icons.CloudDownload size={20}/></button>
                        <div className="user-profile" onClick={onEditProfile}>
                            <Icons.User size={20}/> <span>{user.name}</span>
                        </div>
                    </div>
                </header>
            );
        };

        const Sidebar = ({ activeTab, setActiveTab, collapsed, toggleCollapse }) => {
            const items = [
                { id: 'descargas', label: 'Descargas', icon: <Icons.Download size={20}/> },
                { id: 'campanas', label: 'Campañas', icon: <Icons.Layers size={20}/> },
                { id: 'tolvas', label: 'Tolvas', icon: <IconTolva size={22}/> },
                { id: 'cosechadoras', label: 'Cosechadoras', icon: <IconCosechadora size={22}/> },
                { id: 'establecimientos', label: 'Establecimientos', icon: <Icons.MapPin size={20}/> },
                { id: 'configuracion', label: 'Configuración', icon: <Icons.Settings size={20}/> },
            ];
            return (
                <div className={`sidebar ${collapsed ? 'collapsed' : ''}`}>
                    {items.map(i => (
                        <div key={i.id} className={`sidebar-item ${activeTab===i.id ? 'active' : ''}`} onClick={() => setActiveTab(i.id)}>
                            {i.icon} <span>{i.label}</span>
                        </div>
                    ))}
                    <div className="sidebar-footer">
                        <button className="nav-icon-btn" style={{color:'var(--text-light)', marginLeft:'auto'}} onClick={toggleCollapse}>
                            {collapsed ? <Icons.ChevronRight/> : <Icons.ChevronLeft/>}
                        </button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [darkMode, setDarkMode] = useState(false);
            const [activeTab, setActiveTab] = useState('descargas');
            const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
            const [user, setUser] = useState({ name: 'Usuario', lastname: '', email: 'usuario@agdp.com', phone: '' });
            const [isProfileOpen, setProfileOpen] = useState(false);

            useEffect(() => { document.body.className = darkMode ? 'dark-mode' : ''; }, [darkMode]);

            return (
                <div className="app-container">
                    <Header 
                        darkMode={darkMode} 
                        toggleDarkMode={() => setDarkMode(!darkMode)} 
                        toggleSidebar={() => setSidebarCollapsed(false)} 
                        user={user}
                        onEditProfile={() => setProfileOpen(true)}
                    />
                    <div className="main-layout">
                        <Sidebar 
                            activeTab={activeTab} 
                            setActiveTab={setActiveTab} 
                            collapsed={sidebarCollapsed}
                            toggleCollapse={() => setSidebarCollapsed(!sidebarCollapsed)}
                        />
                        <main style={{flex:1, overflow:'hidden', display:'flex', flexDirection:'column'}}>
                            {activeTab === 'descargas' && <DashboardContent />}
                            {activeTab === 'establecimientos' && <EstablecimientosView />}
                            {activeTab !== 'descargas' && activeTab !== 'establecimientos' && (
                                <div style={{padding:'2rem', textAlign:'center', color:'var(--text-light)'}}>
                                    Sección {activeTab}
                                </div>
                            )}
                        </main>
                    </div>
                    
                    <ProfileModal 
                        isOpen={isProfileOpen} 
                        onClose={() => setProfileOpen(false)} 
                        user={user} 
                        onSave={(data) => { setUser(data); setProfileOpen(false); }} 
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
